<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TirAssist — Парковки</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="style.css?v=26">
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash-screen">
    <div id="splash-content">
      <img id="splash-logo" src="logo_tir.png" alt="TIR">
    </div>
  </div>

  <div id="map"></div>

  <!-- Layer toggle — top-right standalone -->
  <button id="layer-btn" class="map-ctrl-btn map-layer-btn" title="Слои карты">
    <!-- satellite_alt icon (default: спутник режим) -->
    <svg id="layer-icon-satellite" viewBox="0 -960 960 960" fill="currentColor" style="width:22px;height:22px">
      <path d="M560-32v-80q117 0 198.5-81.5T840-392h80q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T560-32Zm0-160v-80q50 0 85-35t35-85h80q0 83-58.5 141.5T560-192ZM222-57q-15 0-30-6t-27-17L23-222q-11-12-17-27t-6-30q0-16 6-30.5T23-335l127-127q23-23 57-23.5t57 22.5l50 50 28-28-50-50q-23-23-23-56t23-56l57-57q23-23 56.5-23t56.5 23l50 50 28-28-50-50q-23-23-23-56.5t23-56.5l127-127q12-12 27-18t30-6q15 0 29.5 6t26.5 18l142 142q12 11 17.5 25.5T895-730q0 15-5.5 30T872-673L745-546q-23 23-56.5 23T632-546l-50-50-28 28 50 50q23 23 22.5 56.5T603-405l-56 56q-23 23-56.5 23T434-349l-50-50-28 28 50 50q23 23 22.5 57T405-207L278-80q-11 11-25.5 17T222-57Zm0-79 42-42-142-142-42 42 142 142Zm85-85 42-42-142-142-42 42 142 142Zm184-184 56-56-142-142-56 56 142 142Zm198-198 42-42-142-142-42 42 142 142Zm85-85 42-42-142-142-42 42 142 142Z"/>
    </svg>
    <!-- map icon (схема режим) -->
    <svg id="layer-icon-map" viewBox="0 0 24 24" fill="currentColor" class="hidden">
      <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
    </svg>
  </button>

  <!-- Right Map Controls — zoom group (top) -->
  <div id="map-controls">
    <button id="zoom-in-btn" class="map-ctrl-btn map-ctrl-zoom" title="Приблизить">+</button>
    <button id="zoom-out-btn" class="map-ctrl-btn map-ctrl-zoom" title="Отдалить">−</button>
  </div>

  <!-- Right Map Controls — settings/locate group (bottom) -->
  <div id="map-controls-bottom">
    <button id="filter-btn" class="map-ctrl-btn" title="Настройки фильтров">
      <!-- settings icon -->
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41L9.25 5.35C8.66 5.59 8.12 5.92 7.63 6.29L5.24 5.33c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.3-.07.63-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
      </svg>
    </button>
    <button id="locate-btn" class="map-ctrl-btn" title="Моё местоположение">
      <!-- near_me icon -->
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 3L3 10.53v.98l6.84 2.65L12.48 21h.98L21 3z"/>
      </svg>
    </button>
  </div>

  <!-- Bottom Route Bar -->
  <div id="bottom-route-bar">
    <div class="route-row" id="route-row-from">
      <!-- near_me icon as from-indicator (orange) -->
      <span class="route-from-icon">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 3L3 10.53v.98l6.84 2.65L12.48 21h.98L21 3z"/>
        </svg>
      </span>
      <input type="text" id="route-from" placeholder="Откуда" autocomplete="off">
      <button id="route-from-clear" class="route-icon-btn hidden" title="Очистить">✕</button>
      <button id="locate-in-route-btn" class="route-icon-btn" title="Вставить моё местоположение">
        <!-- near_me icon -->
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 3L3 10.53v.98l6.84 2.65L12.48 21h.98L21 3z"/>
        </svg>
      </button>
    </div>
    <div class="route-bar-divider"></div>
    <div class="route-row" id="route-row-to">
      <span class="route-dot route-dot-to"></span>
      <input type="text" id="route-to" placeholder="Куда" autocomplete="off">
      <button id="route-to-clear" class="route-icon-btn hidden" title="Очистить">✕</button>
      <button id="route-go-btn" class="route-go-btn" title="Найти парковки">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"/>
          <polyline points="12 5 19 12 12 19"/>
        </svg>
      </button>
    </div>
    <button id="route-clear-btn" class="route-clear-btn hidden">✕ Очистить маршрут</button>
  </div>

  <!-- Filter / Dims Panel -->
  <div id="filter-panel" class="floating-panel hidden">
    <div id="panel-tabs">
      <button class="panel-tab active" data-tab="filters">Фильтры</button>
      <button class="panel-tab" data-tab="dims">Габариты</button>
    </div>

    <div id="pane-filters">

      <!-- Тип парковки -->
      <div class="filter-section">
        <div class="filter-section-title">Тип</div>
        <div class="filter-chip-row">
          <button class="fchip type-chip" data-type="parking">
            <img src="parking_free.png" width="18" alt=""> Parking
          </button>
          <button class="fchip type-chip" data-type="spot">
            <img src="spot.png?v=2" width="18" alt=""> Spot
          </button>
          <button class="fchip type-chip" data-type="prom">
            <img src="prom.png" width="18" alt=""> Prom
          </button>
          <button class="fchip type-chip" data-type="магазин">
            <img src="shop.png" width="18" alt=""> Магазин
          </button>
        </div>
      </div>

      <!-- Удобства -->
      <div class="filter-section">
        <div class="filter-section-title">Удобства</div>
        <div class="filter-chip-row">
          <button class="fchip" data-filter="shower"><img src="icon_shower.png" width="16" alt=""> Душ</button>
          <button class="fchip" data-filter="toilet"><img src="icon_wc.png" width="16" alt=""> Туалет</button>
          <button class="fchip" data-filter="restaurant"><img src="icon_cafe.png" width="16" alt=""> Кафе</button>
          <button class="fchip" data-filter="laundry"><img src="icon_laundry.png" width="16" alt=""> Прачечная</button>
          <button class="fchip" data-filter="lighting">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
            Освещение
          </button>
          <button class="fchip" data-filter="fencing">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M22 12v2h-2v-2h-2v2h-2v-2h-2v2h-2v-2H8v2H6v-2H4v2H2v-2H0v-2h2V8H0V6h2V4h2v2h2V4h2v2h2V4h2v2h2V4h2v2h2V4h2v2h2V6h-2v2h2v2h-2v2h2zM4 8v2h2V8H4zm4 0v2h2V8H8zm4 0v2h2V8h-2zm4 0v2h2V8h-2z"/></svg>
            Ограждение
          </button>
        </div>
      </div>

      <!-- Карты оплаты -->
      <div class="filter-section">
        <div class="filter-section-title">Карты оплаты</div>
        <div class="filter-chip-row">
          <button class="fchip" data-filter="dkv"><img src="dkv.png" width="20" alt=""> DKV</button>
          <button class="fchip" data-filter="snap"><img src="snap.png" width="20" alt=""> Snap</button>
        </div>
      </div>

      <!-- Оплата -->
      <div class="filter-section">
        <div class="filter-section-title">Оплата</div>
        <div class="filter-chip-row">
          <button class="fchip pay-btn" data-paid="false">Бесплатно</button>
          <button class="fchip pay-btn" data-paid="true">Платно</button>
        </div>
      </div>

      <button id="filter-clear" class="filter-clear-btn-panel">Сбросить всё</button>
    </div>

    <div id="pane-dims" class="hidden">
      <div class="dims-grid">
        <label class="dims-label">Высота (м)<input id="dim-height" type="number" step="0.1" min="0" class="dims-input"></label>
        <label class="dims-label">Ширина (м)<input id="dim-width" type="number" step="0.1" min="0" class="dims-input"></label>
        <label class="dims-label">Длина (м)<input id="dim-length" type="number" step="0.1" min="0" class="dims-input"></label>
        <label class="dims-label">Вес (т)<input id="dim-weight" type="number" step="1" min="0" class="dims-input"></label>
      </div>
      <button id="dims-save" class="primary-btn">Сохранить</button>
    </div>
  </div>

  <!-- Add Parking FAB -->
  <button id="add-parking-btn" title="Добавить парковку">＋</button>

  <!-- Add Parking Modal -->
  <div id="add-modal" class="hidden">
    <div id="add-modal-overlay" onclick="app.closeAddModal()"></div>
    <div id="add-modal-content">
      <div id="add-modal-header">
        <h3>Добавить парковку</h3>
        <button id="add-modal-close" onclick="app.closeAddModal()">✕</button>
      </div>
      <div id="add-modal-body">

        <!-- Название -->
        <div class="form-group">
          <label>Название *</label>
          <input type="text" id="add-name" placeholder="Например: Track Stop">
        </div>

        <!-- Координаты -->
        <div class="form-group">
          <label>Координаты *</label>
          <div class="coords-row">
            <input type="text" id="add-coords" placeholder="Введите координаты" autocomplete="off">
            <button id="add-coords-paste" class="coords-action-btn" title="Вставить из буфера">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/>
              </svg>
            </button>
            <button id="add-coords-locate" class="coords-action-btn locate" title="Вставить моё местоположение">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 3L3 10.53v.98l6.84 2.65L12.48 21h.98L21 3z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Тип парковки -->
        <div class="form-group">
          <label>Тип парковки *</label>
          <div class="type-chips-grid">
            <button class="type-chip-add active" data-type="parking">
              <img src="parking_free.png" width="20" alt="">
              <span>Паркинг</span>
            </button>
            <button class="type-chip-add" data-type="spot">
              <img src="spot.png?v=2" width="20" alt="">
              <span>Spot</span>
            </button>
            <button class="type-chip-add" data-type="prom">
              <img src="prom.png" width="20" alt="">
              <span>Prom</span>
            </button>
            <button class="type-chip-add" data-type="магазин">
              <img src="shop.png" width="20" alt="">
              <span>Магазин</span>
            </button>
          </div>
        </div>

        <!-- Удобства -->
        <div class="form-group">
          <label>Удобства *</label>
          <div class="amenity-grid">
            <label class="amenity-chip"><input type="checkbox" value="shower">
              <span class="amenity-icon">
                <img src="icon_shower.png" width="26" height="26" style="object-fit:contain" alt="">
              </span>
              <span class="amenity-label">Душ</span>
            </label>
            <label class="amenity-chip"><input type="checkbox" value="toilet">
              <span class="amenity-icon">
                <img src="icon_wc.png" width="26" height="26" style="object-fit:contain" alt="">
              </span>
              <span class="amenity-label">Туалет</span>
            </label>
            <label class="amenity-chip"><input type="checkbox" value="restaurant">
              <span class="amenity-icon">
                <img src="icon_cafe.png" width="26" height="26" style="object-fit:contain" alt="">
              </span>
              <span class="amenity-label">Кафе</span>
            </label>
            <label class="amenity-chip"><input type="checkbox" value="laundry">
              <span class="amenity-icon">
                <img src="icon_laundry.png" width="26" height="26" style="object-fit:contain" alt="">
              </span>
              <span class="amenity-label">Прачечная</span>
            </label>
            <label class="amenity-chip"><input type="checkbox" value="lighting">
              <span class="amenity-icon">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
              </span>
              <span class="amenity-label">Освещение</span>
            </label>
            <label class="amenity-chip"><input type="checkbox" value="fencing">
              <span class="amenity-icon">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 12v2h-2v-2h-2v2h-2v-2h-2v2h-2v-2H8v2H6v-2H4v2H2v-2H0v-2h2V8H0V6h2V4h2v2h2V4h2v2h2V4h2v2h2V4h2v2h2V4h2v2h2V6h-2v2h2v2h-2v2h2zM4 8v2h2V8H4zm4 0v2h2V8H8zm4 0v2h2V8h-2zm4 0v2h2V8h-2z"/></svg>
              </span>
              <span class="amenity-label">Ограждение</span>
            </label>
          </div>
        </div>

        <!-- Платно / Бесплатно -->
        <div class="form-group">
          <div class="pay-toggle-row">
            <button class="pay-btn-add active" data-paid="false">Бесплатно</button>
            <button class="pay-btn-add" data-paid="true">Платно</button>
          </div>
        </div>

        <!-- Карты оплаты -->
        <div class="form-group">
          <label>Карты оплаты</label>
          <div class="services-grid">
            <label class="service-check"><input type="checkbox" value="dkv">
              <img src="dkv.png" width="22" style="object-fit:contain" alt=""> DKV
            </label>
            <label class="service-check"><input type="checkbox" value="snap">
              <img src="snap.png" width="22" style="object-fit:contain" alt=""> Snap
            </label>
          </div>
        </div>

        <!-- Отправить -->
        <button id="add-submit-btn" class="add-submit-styled">
          Отправить
        </button>

      </div>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div id="bottom-sheet" class="hidden">
    <div id="sheet-drag-handle">
      <div id="sheet-handle"></div>
    </div>
    <div id="sheet-content">

      <!-- Header: name + admin delete + distance -->
      <div id="sheet-header">
        <h2 id="parking-name"></h2>
        <div id="sheet-header-right">
          <span id="parking-distance" class="distance-badge hidden"></span>
          <button id="parking-delete-btn" class="sheet-admin-btn hidden" title="Удалить метку">
            <img src="icon_delete.png" width="22" height="22" alt="delete">
          </button>
        </div>
      </div>

      <!-- Coordinates -->
      <div id="parking-coords-row" class="hidden">
        <div id="parking-coords-box">
          <svg class="coords-pin-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
          <span id="parking-coords"></span>
        </div>
        <button id="parking-coords-copy" class="copy-btn" title="Скопировать координаты">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
        </button>
      </div>

      <!-- Rating summary -->
      <div id="parking-rating-summary" class="hidden">
        <span id="parking-rating-stars"></span>
        <span id="parking-rating-count"></span>
      </div>

      <!-- Description -->
      <div id="parking-description-row" class="sheet-row hidden">
        <span class="sheet-label">Описание</span>
        <div id="parking-description-wrap">
          <p id="parking-description" class="sheet-description"></p>
          <button type="button" id="parking-description-toggle" class="description-toggle hidden">Развернуть</button>
        </div>
      </div>

      <!-- Services tags -->
      <div id="services-row"></div>

      <!-- Google Maps button -->
      <button id="maps-btn" class="sheet-maps-btn">
        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        Открыть в Google Maps
      </button>

      <!-- Divider before reviews -->
      <div class="sheet-divider"></div>

      <!-- Reviews section -->
      <div id="reviews-section">
        <div id="reviews-list"></div>

        <!-- Leave a review -->
        <div id="review-form">
          <div class="review-form-title">Оставить оценку</div>
          <div id="review-stars-input">
            <span class="star-input" data-star="1">★</span>
            <span class="star-input" data-star="2">★</span>
            <span class="star-input" data-star="3">★</span>
            <span class="star-input" data-star="4">★</span>
            <span class="star-input" data-star="5">★</span>
          </div>
          <textarea id="review-comment" placeholder="Комментарий (необязательно)" rows="2"></textarea>
          <button id="review-submit-btn" class="review-submit-btn">Отправить отзыв</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast hidden"></div>

  <!-- Route loading overlay -->
  <div id="route-loading" class="hidden">
    <div class="route-loading-box">
      <div class="route-spinner"></div>
      <p>Рассчитывается маршрут…</p>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>
  <script src="app.js?v=27"></script>
</body>
</html>
